// Prisma schema for SproutShare - PostgreSQL database
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String   @id @default(cuid())
  username             String   @unique
  email                String   @unique
  passwordHash         String
  joinDate             DateTime @default(now())
  bio                  String?  @db.VarChar(500)
  profilePicture       String?
  plantImages          String[] @default([])
  locationZip          String?
  emailNotifications   Boolean  @default(true)
  tradeNotifications   Boolean  @default(true)
  messageNotifications Boolean  @default(true)
  tradesCompleted      Int      @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relationships
  following        UserFollow[] @relation("UserFollower")
  followers        UserFollow[] @relation("UserFollowing")
  likedPlants      Plant[]      @relation("PlantLikes")
  trades           Trade[]
  participatingTrades Trade[] @relation("TradeCounterparty")
  tradeRequests    TradeRequest[] @relation("UserTradeRequests")
  sentMessages     Message[]    @relation("SentMessages")
  receivedMessages Message[]    @relation("ReceivedMessages")
  forumPosts       ForumPost[]
  reviewsGiven     TradeReview[] @relation("Reviewer")
  reviewsReceived  TradeReview[] @relation("Reviewee")

  @@index([email])
  @@index([username])
  @@map("users")
}

model Plant {
  id               String      @id @default(cuid())
  name             String
  genus            String?
  species          String?
  description      String      @db.Text
  imageURL         String      @default("/placeholder-plant.jpg")
  cycle            String?
  wateringFrequency String?
  nativeRegion     String?
  careTips         String?     @db.Text
  tradeStatus      TradeStatus @default(available)
  idealTemp        String?
  sunlight         String?
  tags             String[]    @default([])
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Relationships
  likedBy         User[]  @relation("PlantLikes")
  offeredTrades   Trade[] @relation("OfferedPlants")
  requestedTrades Trade[] @relation("RequestedPlants")

  @@index([name])
  @@index([tradeStatus])
  @@index([genus, species])
  @@map("plants")
}

model Trade {
  id               String      @id @default(cuid())
  ownerId          String
  offeredItem      String
  requestedItem    String
  locationZip      String
  latitude         Float
  longitude        Float
  status           TradeStatus @default(active)
  offeredPlantId   String?
  requestedPlantId String?
  counterpartyId   String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Relationships
  owner          User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  offeredPlant   Plant? @relation("OfferedPlants", fields: [offeredPlantId], references: [id])
  requestedPlant Plant? @relation("RequestedPlants", fields: [requestedPlantId], references: [id])
  reviews        TradeReview[]
  counterparty   User?  @relation("TradeCounterparty", fields: [counterpartyId], references: [id])
  requests       TradeRequest[]

  @@index([ownerId])
  @@index([status])
  @@index([counterpartyId])
  @@index([latitude, longitude]) // For geospatial bounding box queries
  @@index([status, latitude, longitude]) // Composite for filtered geospatial queries
  @@index([status, createdAt]) // For filtered latest trades
  @@index([createdAt])
  @@map("trades")
}

model Message {
  id         String    @id @default(cuid())
  senderId   String
  receiverId String
  content    String    @db.Text
  read       Boolean   @default(false)
  deleted    Boolean   @default(false)
  deletedAt  DateTime?
  timestamp  DateTime  @default(now())
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relationships
  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId, receiverId]) // For conversation queries
  @@index([receiverId, read]) // For unread messages
  @@index([receiverId, deleted, timestamp]) // Composite for active conversations
  @@index([timestamp])
  @@index([deleted])
  @@map("messages")
}

model ForumPost {
  id        String   @id @default(cuid())
  authorId  String
  title     String
  content   String
  category  String   @default("general")
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  author  User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  replies ForumReply[]

  @@index([authorId])
  @@index([category])
  @@index([category, timestamp]) // Composite for category browsing
  @@index([timestamp])
  @@map("forum_posts")
}

model ForumReply {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  content   String
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  post ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
  @@index([timestamp])
  @@map("forum_replies")
}

model UserFollow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("UserFollower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("user_follows")
}

model TradeReview {
  id          String   @id @default(cuid())
  tradeId     String
  reviewerId  String
  revieweeId  String
  rating      Int      // 1-5 stars
  comment     String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  trade    Trade @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  reviewer User  @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee User  @relation("Reviewee", fields: [revieweeId], references: [id], onDelete: Cascade)

  @@unique([tradeId, reviewerId]) // One review per trade per reviewer
  @@index([revieweeId]) // For quick lookup of user's average rating
  @@index([tradeId])
  @@index([rating])
  @@map("trade_reviews")
}

model TradeRequest {
  id          String              @id @default(cuid())
  tradeId     String
  requesterId String
  status      TradeRequestStatus  @default(pending)
  message     String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  trade      Trade @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  requester  User  @relation("UserTradeRequests", fields: [requesterId], references: [id], onDelete: Cascade)

  @@unique([tradeId, requesterId])
  @@index([tradeId])
  @@index([requesterId])
  @@map("trade_requests")
}

enum TradeStatus {
  available
  pending
  traded
  active
  completed
}

enum TradeRequestStatus {
  pending
  cancelled
}
